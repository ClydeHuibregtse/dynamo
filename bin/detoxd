#!/bin/bash
# --------------------------------------------------------------------------------------------------
# Process to run detox periodically.
#
# v1.0                                                                       Y.Iiyama (Apr 19, 2016)
# --------------------------------------------------------------------------------------------------

if [ -z "$DYNAMO_BASE" ]
then
  echo "Dynamo environment is not set."
  exit 1
fi

while [ 1 ]
do

  # make sure the log directory exists
  mkdir -p $DYNAMO_LOGDIR

  # generate specific log file
  TAG=`date "+%s"`
  LOG=$DYNAMO_LOGDIR/detox-${TAG}.log
  touch $LOG

  if [ $(du -mc $DYNAMO_LOGDIR/detox-* | awk '/total/ {print $1}') -gt 10000 ] # logs exceeding 10 GB
  then
    find $DYNAMO_LOGDIR -name detox-* -mtime 1 -delete
  fi

  $DYNAMO_BASE/bin/detox --log-level INFO --log-file $LOG --repeat 10 $DYNAMO_DETOX_INTERVAL

  # take a deep breath
  sleep 5

done

exit 0

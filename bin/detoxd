#!/bin/bash
# --------------------------------------------------------------------------------------------------
# Process to run detox periodically.
#
# v1.0                                                                       Y.Iiyama (Apr 19, 2016)
# --------------------------------------------------------------------------------------------------

RUNS_PER_CYCLE=10

export DYNAMO_BASE=$(dirname $(cd $(dirname ${BASH_SOURCE[0]}); pwd))
source $DYNAMO_BASE/etc/profile.d/init.sh

while true
do

  # make sure the log directory exists
  mkdir -p $DYNAMO_LOGDIR

  # generate specific log file
  TAG=`date "+%s"`
  LOG=$DYNAMO_LOGDIR/detox-${TAG}.log

  if [ $(du -mc $DYNAMO_LOGDIR/detox-* 2>/dev/null | awk '/total/ {print $1}') -gt 10000 ] # logs exceeding 10 GB
  then
    find $DYNAMO_LOGDIR -name detox-* -mtime 1 -delete
  fi

  echo "Start $RUNS_PER_CYCLE loops; log file $LOG" >> $LOG
  $DYNAMO_BASE/bin/detox --test-run --log-level INFO --log-file $LOG --repeat $RUNS_PER_CYCLE $DYNAMO_DETOX_INTERVAL 2>>$LOG
  RC=$?

  if [ $RC -ne 0 ]
  then
    # execution failed - recover inventory to avoid running with corrupt inventory
    $DYNAMO_BASE/bin/execlib common/interface/store.py restore --timestamp last
    $DYNAMO_BASE/bin/execlib common/interface/store.py set_last_update 0
    if [ -e /var/run/dynamo-detoxd.pid ]
    then
      # this process is run as a daemon - send email and continue
      echo "Help! Detox failed. Return code $RC. Check log $LOG on $HOSTNAME." | mailx -s "Dynamo error" t2lab@mit.edu
    else
      exit $RC 
    fi
  fi

  # take a deep breath
  sleep 5

done

exit 0
